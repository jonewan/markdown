# 内存寻址（二）

## 一、硬件中的分页

分页单元（paging unit）把线性地址转换成物理地址。其中的一个关键任务是把所请求的访问类型与线性地址的访问权限相比较，若此次内存访问无效，则产生一个缺页异常。

为了高效工作，线性地址被分成以固定长度的`页（page）`。页内部连续的`线性地址`被映射到连续的物理地址中。“页”指的是一组线性地址，或者指的是这组线性地址中包含的数据。分页单元将所有的`物理内存`分成固定长度的`页框`或叫`物理页`（page frame）。每一个页框包含一个页（page）。页框长度=页长度，页框是主存的一部分，是物理内存，页指的是一个数据块，可以存放在任何页框和磁盘中。

将线性地址映射到物理地址的数据结构称为`页表（page table）`。页表存放在内存（DRAM）中，并在启用分页单元之前必须由内核对页表进行适当的初始化。

### 1.1 常规分页

80386开始，Intel处理器的分页单元处理4KB页。

32位线性地址被划分为三个区域：

* *Directory*（目录） [22:31]
* *Table*(页表) [12:21]
* *Offset*(偏移量)  [0:11]

线性地址的转换分为两步，每一步基于一种转换表，第一步的转换表称为`页目录表`，第二部的转换表称为`页表`。

![常规分页](http://life.chinaunix.net/bbsfile/forum/linux/month_0801/20080116_df60e28590bbda258d8cRX7n2zBpGJ9Z.jpg)

正在使用的页目录存放在控制寄存器`cr3`中。线性地址中的*Directory*字段决定页目录中的目录项，而目录项指向适当的页表。线性地址中*Table*字段决定页表中的表项，表项含有页所在页框的物理地址，线性地址中*Offset*字段决定在页框中的偏移。

由于线性地址中*Directory*字段与*Table*字段都是10位，因此页目录与页表都可多达$2^{10}$项，因此一个页目录可以寻址$2^{10}$\*$2^{10}$\*$2^{12}$ = 4GB。

页目录`项`与页表`项`都有同样的结构，每项包含下面字段：

* Present标志：为1表示所指的页（或页表）就在主存内，为0表示这一页不在主存内。
* Field包含页框物理地址的最高20位字段：由于每一个页框有4KB容量，其物理地址必须是4096的倍数，因此物理地址的低12位总是0，若该字段指向一个页目录，相应的页框就含有一个页表，如果它指向一个页表，相应的页框含有一页数据
* Accessed标志：分页单元对页框进行寻址时设置此标志，当选中的页被交换出去时可由操作系统置0
* Dirty标志：只应用于页表项，每当对一个页框进行写操作时设置该标志，当选中的页被交换出去时可由操作系统置0
* Read/Write标志：包含页或页表的存取权限
* User/Supervisior标志：访问页或页表的特权级
* PCD和PWT标志：控制cache处理页或页表的方式
* Page Size标志：只应用于页目录项，置1，则页目录项指的是2MB或4MB页框
* Global标志：只应用于页表项。

### 1.2 物理地址扩展（PAE）分页机制

从Pentium Pro开始，Intel将CPU管脚从32个增加至36个，其所有处理器寻址能力达$2^{36}$=64GB，因此引入`物理地址扩展（Physical Address Extension，PAE）`实现将32位线性地址转换为36位物理地址。通过设置cr4寄存器的PAE标志激活PAE机制。

* 64G内存被分为$2^{24}$个页框，页表项的物理地址字段从20位扩展为24位。
* 引入页目录指针表（Page Directory Pointer Table，PDPT），由4个64位表项组成。
* cr3寄存器包含一个27位PDPT基地址。
* 当把线性地址映射到4KB页时（页目录项中的PS标志位置0），32位线性地址按如下方式解释：
  位    |   描述
  ---   |   ---
  [0:11]    |   4KB页内偏移（offset）
  [12:20]   |   页表内偏移
  [21:29]   |   页目录偏移
  [30:31]   |   PDPT偏移

* 当把线性地址映射到2MB页时（页目录项中的PS标志位置1），32位线性地址按如下方式解释：
  位    |   描述
  ---   |   ---
  [0:20]    |   2MB页内偏移（offset）
  [21:29]   |   页目录偏移
  [30:31]   |   PDPT偏移

## 二、硬件高速缓存（cache）

为了缩小CPU与RAM之间的速度不匹配，引入了硬件高速缓存，硬件告诉缓存基于局部性原理，使用LRU（最近最少使用）算法。80x86引入cache line的单位，cache line由几十个连续的字节组成，以burst mode（突发模式）在慢速DRAM（内存）与高速SRAM（cache）之间传送数据，实现高速缓存。

### 2.1 Burst Mode 突发模式

所谓的“突发”是指当我们对一个地址进行寻址并操作完成后，不必再重新对下一个地址进行寻址，而是直接进行操作。这样就节省了很多的时间。

* 读：初始化→发行地址→RCD→发列地址→CL→数据
* 写：初始化→发行地址→RCD→发列地址→数据

### 2.2 高速缓存结构

高速缓存单元插在分页单元与内存之间。其包含一个硬件高速缓存内存（hardware cache memory）和一个高速缓存控制器（cache controller）。高速缓存内存中存放内存（DRAM）中真正的行（line）。高速缓存控制器存放一个表项数组，数组中的每个表项对应高速缓存中的一个cache line。cache controler中的每个cache line有一个标签（tag）和几个状态标志（flag）。其中标签（tag）由若干位（bit）组成，这些bit让cache controler能够分辨出该cache line当前所映射的内存（DRAM）单元。

内存的物理地址被分为3份，高几位对应cache line中的tag，中间几位对应cache controler的子集索引，低几位对应cache line的偏移量。


### 2.3 cache命中

当访问一个内存（DRAM）单元时，CPU从物理地址中提取出子集的索引号并把子集中所有的cache line的tag与物理地址的高几位比较，若有某一行的tag与物理地址高几位相同，则代表CPU `cache命中`，否则`cache未命中`。

### 2.4 写通与写回
写通（write-through）是指cache controler既写RAM也写cache line。
写回（write-back）是指cache controler只更新cache line但不改变RAM中的内容，但是写回结束后更新RAM。

Linux对于所有的页框都启用高速缓存，对于写操作总是采用回写（write back）策略。

## 三、转换后援缓冲器（TLB）

转换后援缓冲器（Translation Lookaside Buffer，TLB）俗称`快表`，用于加速`线性地址（虚拟地址）`到`物理地址`的转换。当一个线性地址第一次使用时通过访问内存（DRAM）中的页表计算出相应的物理地址，同时，将计算出的物理地址存入TLB的一个表项中，以便以后可以快速的转换。

在多处理器系统中，每个CPU都有自己的TLB，称之为CPU的`本地TLB`。

当CPU的cr3寄存器被修改时，由于新的一组页表被启用而TLB指向的是旧数据，因此，硬件自动将本地TLB中的所有表项无效。

## 四、Linux中的分页

为了同时适用32位于64位系统，从Linux2.1.11后Linux采用四级分页模型，分贝称为：

* 页全局目录（Page Global Directory）
* 页上级目录（Page Upper Directory）
* 页中间目录（Page Middle Directory）
* 页表（Page Table）

线性地址（虚拟地址）被分为5个部分，其中每个部分的位数由计算机的体系结构决定。

![Linux分页](http://life.chinaunix.net/bbsfile/forum/linux/month_0801/20080116_3a1b1ea4249e4a3ce05fZnTyR3rfXy3h.jpg)

* 对于没有启动物理地址扩展的32位系统，Linux通过使页上级目录（PUD）与页中间目录(PMD)的位全为0来使用二级分页模型。
* 对于启动物理地址扩展的32位系统，Linux的页全局目录（PGD）对应硬件分页中的页目录指针表（PDPT），取消了页上级目录（PUD），页中间目录（PMD）对应硬件分页的页目录，页表对应页表。
* 64位系统使用三级还是四级分页取决于硬件上对线性地址的划分。

